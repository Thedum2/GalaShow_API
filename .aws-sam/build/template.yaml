AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Galashow API (Dev & Prod)
Parameters:
  StageNameParam:
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - prod
Conditions:
  IsDev:
    Fn::Equals:
    - Ref: StageNameParam
    - dev
  IsProd:
    Fn::Equals:
    - Ref: StageNameParam
    - prod
Globals:
  Function:
    Timeout: 10
    MemorySize: 128
Resources:
  DevApi:
    Condition: IsDev
    Type: AWS::Serverless::Api
    Properties:
      Name: Galashow-dev
      StageName: dev
      Cors:
        AllowMethods: '''GET,OPTIONS'''
        AllowHeaders: '''Content-Type'''
  ProdApi:
    Condition: IsProd
    Type: AWS::Serverless::Api
    Properties:
      Name: Galashow-prod
      StageName: prod
      Cors:
        AllowMethods: '''GET,OPTIONS'''
        AllowHeaders: '''Content-Type'''
  DevHelloFunction:
    Condition: IsDev
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DevHelloFunction
      Handler: HelloWorld::HelloWorld.Function::FunctionHandler
      Runtime: dotnet6
      Events:
        Hello:
          Type: Api
          Properties:
            RestApiId:
              Ref: DevApi
            Path: /hello
            Method: get
    Metadata:
      SamResourceId: DevHelloFunction
  ProdHelloFunction:
    Condition: IsProd
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ProdHelloFunction
      Handler: HelloWorld::HelloWorld.Function::FunctionHandler
      Runtime: dotnet6
      Events:
        Hello:
          Type: Api
          Properties:
            RestApiId:
              Ref: ProdApi
            Path: /hello
            Method: get
    Metadata:
      SamResourceId: ProdHelloFunction
  DevDomain:
    Condition: IsDev
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: api-dev.galashow.xyz
      RegionalCertificateArn: arn:aws:acm:ap-northeast-2:610495549763:certificate/2c301078-0b91-4d2b-b88c-6e1a643dab7c
      EndpointConfiguration:
        Types:
        - REGIONAL
  ProdDomain:
    Condition: IsProd
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: api.galashow.xyz
      RegionalCertificateArn: arn:aws:acm:ap-northeast-2:610495549763:certificate/2c301078-0b91-4d2b-b88c-6e1a643dab7c
      EndpointConfiguration:
        Types:
        - REGIONAL
  DevBasePathMapping:
    Condition: IsDev
    Type: AWS::ApiGateway::BasePathMapping
    DependsOn: DevApidevStage
    Properties:
      DomainName:
        Ref: DevDomain
      RestApiId:
        Ref: DevApi
      Stage: dev
      BasePath: ''
  ProdBasePathMapping:
    Condition: IsProd
    Type: AWS::ApiGateway::BasePathMapping
    DependsOn: ProdApiprodStage
    Properties:
      DomainName:
        Ref: ProdDomain
      RestApiId:
        Ref: ProdApi
      Stage: prod
      BasePath: ''
  DevDNSRecord:
    Condition: IsDev
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z001166232XN5SLW00H6Z
      Name: api-dev.galashow.xyz
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - DevDomain
          - RegionalDomainName
        HostedZoneId:
          Fn::GetAtt:
          - DevDomain
          - RegionalHostedZoneId
        EvaluateTargetHealth: false
  ProdDNSRecord:
    Condition: IsProd
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z001166232XN5SLW00H6Z
      Name: api.galashow.xyz
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - ProdDomain
          - RegionalDomainName
        HostedZoneId:
          Fn::GetAtt:
          - ProdDomain
          - RegionalHostedZoneId
        EvaluateTargetHealth: false
Outputs:
  DevEndpoint:
    Condition: IsDev
    Description: Dev invoke URL
    Value: https://api-dev.galashow.xyz/hello
  ProdEndpoint:
    Condition: IsProd
    Description: Prod invoke URL
    Value: https://api.galashow.xyz/hello
